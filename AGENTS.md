# LumiLock Discord Bot – AGENT Guide

이 문서는 LumiLock 디스코드 봇(TypeScript + discord.js 기반) 리포지토리에서 작업하는 **모든 AI 에이전트**를 위한 가이드다.  
이 루트의 `AGENTS.md` 규칙은 리포지토리 전체에 적용되며, 더 안쪽 디렉터리에 다른 `AGENTS.md`가 있으면 그쪽이 우선한다.

## 작업 디렉터리 / 경로 규칙 (중요)

- 이 파일이 존재하는 디렉터리가 항상 **리포지토리 루트**이다.
  - 예) Windows: `d:\LumiLock`, WSL: `/mnt/d/LumiLock`
- 코드/설정/문서 변경 시에는 **반드시 이 루트를 기준으로 한 상대 경로**를 사용한다.
  - OS 절대 경로(`/mnt/c/...`, `C:\Users\...` 등)에 직접 새 프로젝트 구조를 만들지 않는다.
- VS Code / Remote 환경에서는 `.../Microsoft VS Code/d:/LumiLock` 같이 중첩된 가상 경로가 보일 수 있다.
  - 이런 경로에 새 파일을 만들지 말고, 실제 루트(`d:\LumiLock` 또는 `/mnt/d/LumiLock`) 아래에서만 작업한다.
- 새 파일을 만들거나 수정한 후에는
  - `pwd`로 현재 작업 디렉터리를 확인하고,
  - `ls` 또는 `cat`으로 해당 파일이 **리포 루트 아래에 실제로 존재하는지** 반드시 확인한다.
- `package.json`, `tsconfig.json`, `src/` 등 프로젝트 스캐폴딩을 생성할 때는
  - 먼저 동일 이름의 파일/디렉터리가 이미 있는지 확인하고,
  - 있다면 덮어쓰지 말고 **필요 최소한의 변경만** 적용한다.
- 이 규칙을 지켜서, IDE에는 안 보이고 컨테이너 내부에만 존재하는 "가짜 경로"에 파일이 생성되는 문제를 방지한다.

## 범위

- LumiLock 디스코드 봇 서비스의 코드, 설정, 문서 전반
- TypeScript / Node.js / discord.js 관련 작업
- CI 스크립트, 인프라 설정이 추가될 경우도 포함 (별도 AGENTS가 없다면)

## 기술 스택 & 일반 원칙

- 언어: **TypeScript**, 가능하면 `strict` 모드 유지
- 런타임: 최신 **Node.js LTS**
- 라이브러리: **discord.js v14** 이상을 기본 가정
- 원칙:
  - 읽기 쉽고 예측 가능한 코드
  - 모듈 책임 분리가 명확한 구조
  - 보안(토큰, 권한, 레이트 리밋)과 안정성을 최우선

## 디렉터리 구조 (권장 기본 형태)

- `src/` – TypeScript 소스 루트
  - `src/bot/` – 클라이언트 초기화, 로그인, 이벤트/명령 등록
  - `src/commands/` – 슬래시/컨텍스트 명령 정의 및 실행 로직
  - `src/events/` – `ready`, `interactionCreate` 등 이벤트 핸들러
  - `src/config/` – 설정, 환경 변수 로딩
  - `src/services/` – 도메인 로직 (예: 잠금/인증/권한 관련)
  - `src/utils/` – 범용 유틸
- `tests/` – 단위/통합 테스트가 생기면 여기에
- 이미 구조가 존재한다면 **기존 구조를 존중**하고, 필요한 최소 변경만 한다.

## 코딩 스타일

- TypeScript
  - `async/await` 선호, Promise 체인 중첩 최소화
  - 불가피한 경우를 제외하고 `any` 지양
  - 외부로 노출되는 함수/클래스는 반환 타입을 명시
- 네이밍
  - 역할을 드러내는 이름 사용: 예) `LockManager`, `registerCommands`, `handleInteraction`
  - 한 글자 변수명은 루프 인덱스 등 정말 짧은 스코프에서만
- 포매팅
  - 이미 존재하는 ESLint/Prettier 설정이 있으면 반드시 준수
  - 없다면: 2-space indent, single quotes, 세미콜론 사용을 기본으로 맞춘다.

## discord.js 사용 규칙

- 이벤트 리스너는 개별 파일로 분리하는 것을 선호
  - 예) `src/events/ready.ts`, `src/events/interactionCreate.ts`
- 명령 구조 예시:
  - `{ data: SlashCommandBuilder, execute(interaction) { ... } }` 형태를 기본 패턴으로 사용
- 에러는 가능한 한 상위로 전파하거나 로깅하고, **조용히 무시하지 않는다**.
- 토큰, 개인 정보, 내부 식별자(예: 내부 DB 키)는 로그/에러 메시지에 노출하지 않는다.
- 레이트 리밋 및 쿨다운이 필요한 명령에서는:
  - 최소한 유저/길드 단위에서 스팸을 막을 수 있는 보호 로직을 고려한다.

## 환경 변수 & 시크릿

- 디스코드 토큰, DB 비밀번호, 외부 API 키는 **절대 하드코딩 금지**.
- `.env` 또는 환경 변수 사용을 기본 가정:
  - 예) `DISCORD_TOKEN`, `CLIENT_ID`, `GUILD_ID`, 기타 서비스 키
- 코드/예시에서는 실제 값 대신 플레이스홀더 사용:
  - 예) `process.env.DISCORD_TOKEN ?? 'YOUR_DISCORD_TOKEN'`
- `.env` 파일 자체는 Git에 커밋하지 않는 것을 기본 전제로 한다.

## 에러 처리 & 로깅

- 비동기 함수에서는 `try/catch`를 적극 사용하고, 가능한 한 에러 타입을 구분한다.
- 로깅:
  - 초기 단계: `console.log / console.warn / console.error` 사용 가능
  - 로깅이 복잡해지면 추후 교체할 수 있도록 별도 로거 유틸을 통해 사용
- 에러 메시지에는:
  - 원인 파악에 필요한 최소 정보만 포함
  - 토큰, 쿠키, 세션 ID, 상세 쿼리 문자열 등은 포함하지 않는다.

## 테스트 & 검증

- 새 기능을 추가할 때 가능하면 **단위 테스트 또는 최소한의 사용 예제**를 함께 추가한다.
- 테스트 프레임워크(Jest 등)가 이미 있으면 **기존 패턴을 따라** 작성한다.
- 일반적으로 다음 스크립트 구성을 목표로 한다 (`package.json` 기준):
  - `build`: TypeScript 컴파일
  - `lint`: ESLint 실행
  - `test`: 테스트 실행

## 변경 작업 시 우선순위

1. 기존 동작을 깨지 않기 (호환성 유지)
2. 보안과 안전성 보존 (권한, 토큰, 레이트 리밋)
3. 리포 전체와 스타일/구조 일관성 유지
4. 요청된 범위 내에서 **필요 최소한의 리팩토링**만 수행
5. 큰 구조 변경이 필요하다면, 코멘트나 설명을 남겨 후속 논의를 가능하게 한다.

## 금지 / 주의 사항

- 디스코드 토큰 및 기타 시크릿을:
  - 코드, 로그, 예시, 문서, 커밋 메시지에 절대 노출하지 않는다.
- 사용자 개인 정보(유저명, DM 내용 등)를 외부 서비스로 전송하거나 장기간 저장하는 기능은
  - 명시적인 요구/설계가 없는 한 추가하지 않는다.
- 불필요한 전역 상태(singleton + mutable 전역 컬렉션 등)를 만들지 말고,
  - 가능하면 의존성 주입 또는 모듈 분리를 통해 관리한다.

## 이 문서 업데이트 정책

- 리포 구조나 사용 기술 스택이 바뀌면, **반드시 이 문서를 갱신**한다.
- 새로운 규칙을 추가할 때는:
  - 가능한 한 구체적이고 측정 가능한 기준으로 작성
  - 기존 규칙과 충돌하는 경우, 어느 쪽이 우선인지 명확히 남긴다.

---

LumiLock 디스코드 봇이 커지면서 이 `AGENTS.md`도 함께 발전시키자.

